KUBECONFIG FILE

apiVersion: v1
clusters:
  - cluster:
      certificate-authority-data: ... (base64 ca.crt)
      server: https://192.168.56.101:6443 (apiserver)
    name: kubernetes
contexts:
  - context:
      cluster: kubernetes (lokasjon)
      user: kubernetes-admin (legitimasjon)
      namespace: ...
    name: kubernetes-admin@kubernetes
current-context: kubernetes-admin@kubernetes
users:
  - name: kubernetes-admin
    user:
      client-certificate-data: ... (base64 cert, token, password)
      client-key-data: ... (private key)

................................................................................
SERTIFIKAT

Nytt sertifikat for ny user

  # Create private key
  $ openssl genrsa -out demouser.key 2048

  # Create CSR
  $ openssl req -new -key demouser.key -out demouser.csr -subj "/CN=demouser"

  # Encode CSR
  $ cat demouser.csr | base64 | tr -d "\n" > demouser.base64.csr 

  # Apply CertificateSigningRequest
  $ cat <<EOF | kubectl apply -f -
    apiVersion: certificates.k8s.io/v1beta1
    kind: CertificateSigningRequest
    metadata:
      name: demouser
    spec:
      groups:
      - system:authenticated
      request: $(cat demouser.base64.csr)
      usages:
      - client auth
    EOF

  # Approve CSR
  $ kubectl certificate approve demouser

  # Get, decode, redirect cert
  $ kubectl get csr demouser -o jsonpath='{ .status.certificate }' | base64 --decode > demouser.crt

  # Read cert
  $ openssl x509 -in demouser.crt -text -noout
  
Bygg kubeconfig-fil

  # Set cluster
  $ kubectl config set-cluster kubernetes-demo \ 
  --server=https://192.168.56.101:6443 \
  --certificate-authority=ca.crt \
  --embed-certs=true \
  --kubeconfig=demouser.conf
  
  # Set credentials
  $ kubectl config set-credentials demouser \
  --client-key=demouser.key
  --client-certificate=demouser.crt \
  --embed-certs=true \
  --kubeconfig=demouser.conf

  # Set context
  $ kubectl config set-context demouser@kubernetes-demo  \
  --cluster=kubernetes-demo \
  --user=demouser \
  --kubeconfig=demouser.conf

  # Set current context
  $ kubectl config use-context demouser@kubernetes-demo --kubeconfig=demouser.conf

Bruk kubeconfig
  autentisering
  kryptering
  
................................................................................
KONTROLLPLANNODE 
/etc/kubernetes/
  manifests/
  pki/
  admin.conf (kubeconfig file: kubernetes-admin login apiserver)
  controller-manager.conf (kubeconfig file: login apiserver)
  kubelet.conf (kubeconfig file: login apiserver)
  scheduler.conf (kubeconfig file: login apiserver)

/etc/kubernetes/pki/
  etcd/
  apiserver-etcd-client.crt
  apiserver-etcd-client.key
  apiserver-kubelet-client.crt
  apiserver-kubelet-client.key
  apiserver.crt (public cert, used for http encryption)
  apiserver.key (private key)
  ca.crt (public cert)
  ca.key (private key)
  front-proxy-ca.crt
  front-proxy-ca.key
  front-proxy-client.crt
  front-proxy-client.key
  sa.key (private key)
  sa.pub (public key)

